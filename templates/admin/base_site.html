<!-- templates/admin/base_site.html - Ù…Ø­Ø¯Ø« ÙˆÙ…ØµØ­Ø­ -->
{% extends "admin/base.html" %}
{% load i18n static %}

{% block title %}
{{ title }} | {% trans 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' %}
{% endblock %}


{% block extrastyle %}
<style>
    /* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø¹ Ø¯Ø¹Ù… Dark Mode ===== */
    :root {
        --bg-color: #f8f9fa;
        --card-bg: white;
        --text-color: #333;
        --header-bg: #2c3e50;
        --border-color: #ecf0f1;
        --primary-color: #ffab25;
        --hover-color: #4a90e2;
        --section: #fdf3ea;
        --shadow: #d8dada;
        --success-bg: #f0fff4;
        --success-color: #38a169;
        --success-border: #9ae6b4;
        --error-bg: #fff5f5;
        --error-color: #e53e3e;
        --error-border: #fc8181;
        --warning-bg: #fffaf0;
        --warning-color: #dd6b20;
        --warning-border: #fbd38d;
    }

    .dark-mode {
        --bg-color: #080c14;
        --card-bg: #1e2a3a;
        --text-color: #ffffff;
        --header-bg: #1e2a3a;
        --border-color: #404040;
        --primary-color: #357abd;
        --hover-color: #ffab25;
        --section: #222b3d;
        --shadow: #28505d;
        --success-bg: #1a3a2e;
        --success-color: #68d391;
        --success-border: #2d5a45;
        --error-bg: #3a1a1a;
        --error-color: #fc8181;
        --error-border: #5a2a2a;
        --warning-bg: #3a2e1a;
        --warning-color: #f6ad55;
        --warning-border: #5a4a2a;
    }

    /* ===== ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Dark Mode ===== */
    #header {
        background: var(--header-bg);
        color: var(--text-color);
        border-bottom: 10px solid var(--primary-color);
        transition: all 0.3s ease;
    }

    #branding h1 {
        color: var(--text-color);
        font-weight: 700;
        font-size: 24px;
    }

    #branding h1 a {
        color: var(--text-color);
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #branding h1 a:hover {
        color: var(--hover-color);
        transform: translateY(-1px);
    }

    #branding h1 a:before {
        content: "ğŸ“";
        font-size: 45px;
    }


    /* ===== Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø¹ Dark Mode ===== */
    #logout-form button[type="submit"] {
        background: none;
        text-decoration: none;
        border: none;
        color: #ffffff;
        font-size: 45px;
        cursor: pointer;
        padding: 5px;
        width: 40;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    #logout-form button[type="submit"]:hover {
        transform: scale(1.2);
        rotate: -45deg;
        color: var(--hover-color);
    }



    /* Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„ */


    /* ===== Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹ Dark Mode ===== */
    .admin-icons {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .admin-icon-btn {
        background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
    }

    .admin-icon-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.2);
            rotate: -30deg;
    }

    .notification-badge {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    /* ===== Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Dark Mode ===== */
    .theme-toggle-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .theme-toggle-btn:hover {
        background-color: var(--section);
        transform: scale(1.1) rotate(15deg);
    }

    /* ===== Ø£Ù†Ù…Ø§Ø· Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ù…Ø¹ Dark Mode ===== */
    .messaging-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 20px 60px var(--shadow);
        width: 500px;
        max-width: 90vw;
        max-height: 80vh;
        z-index: 10000;
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        background: var(--section);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--text-color);
        font-size: 18px;
        font-weight: 600;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        color: var(--text-color);
        opacity: 0.7;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        opacity: 1;
        color: var(--error-color);
        transform: scale(1.1);
    }

    .modal-content {
        padding: 20px;
        max-height: calc(80vh - 80px);
        overflow-y: auto;
        background: var(--card-bg);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-color);
        font-size: 14px;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-color);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
        outline: none;
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
    }

    .hidden {
        display: none;
    }

    .send-btn {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 14px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .send-btn:hover {
        background: var(--hover-color);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--shadow);
    }

    .send-btn:active {
        transform: translateY(0);
    }

    /* ===== Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…Ø¹ Dark Mode ===== */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background: var(--section);
    }

    .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
        opacity: 0.7;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
        color: var(--primary-color);
        opacity: 1;
        border-bottom-color: var(--primary-color);
        background: var(--card-bg);
    }

    .tab-btn:hover:not(.active) {
        background: var(--bg-color);
        color: var(--text-color);
        opacity: 1;
    }

    .tab-content {
        display: none;
        padding: 0;
    }

    .tab-content.active {
        display: block;
    }

    /* ===== Ø£Ù†Ù…Ø§Ø· Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Dark Mode ===== */
    .notifications-list,
    .messages-list {
        padding: 0;
    }

    .notification-item,
    .message-item {
        display: flex;
        gap: 12px;
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
        cursor: pointer;
        background: var(--card-bg);
    }

    .notification-item:hover,
    .message-item:hover {
        background: var(--section);
    }

    .notification-item.unread,
    .message-item.unread {
        background: var(--section);
        border-right: 3px solid var(--primary-color);
    }

    .notification-icon,
    .message-icon {
        font-size: 20px;
        color: var(--primary-color);
        flex-shrink: 0;
        margin-top: 2px;
    }

    .notification-content,
    .message-content {
        flex: 1;
        min-width: 0;
    }

    .notification-title,
    .message-title {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .notification-preview,
    .message-preview {
        color: var(--text-color);
        opacity: 0.8;
        font-size: 13px;
        margin-bottom: 4px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .notification-time,
    .message-time {
        color: var(--text-color);
        opacity: 0.6;
        font-size: 11px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-color);
        opacity: 0.7;
        font-size: 14px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-color);
        opacity: 0.7;
    }

    .empty-state .icon {
        font-size: 48px;
        margin-bottom: 10px;
        opacity: 0.5;
    }

    .empty-state p {
        margin: 0;
        font-size: 14px;
    }

    /* ===== Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ Dark Mode ===== */
    .message-status {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        text-align: center;
    }

    .message-status.success {
        background: var(--success-bg);
        color: var(--success-color);
        border: 1px solid var(--success-border);
    }

    .message-status.error {
        background: var(--error-bg);
        color: var(--error-color);
        border: 1px solid var(--error-border);
    }

    .message-status.warning {
        background: var(--warning-bg);
        color: var(--warning-color);
        border: 1px solid var(--warning-border);
    }

    /* ===== Ø§Ù„Ø¸Ù„ Ø§Ù„Ø®Ù„ÙÙŠ Ù„Ù„Ù†ÙˆØ§ÙØ° ===== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
    }

    /* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª ===== */
    * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    /* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ ===== */
    .module,
    .dashboard .module table th,
    .dashboard .module table td {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .module h2,
    .module caption,
    .inline-group h2 {
        background: var(--section);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    input,
    textarea,
    select {
        background: var(--card-bg) !important;
        color: var(--text-color) !important;
        border-color: var(--border-color) !important;
    }

    input:focus,
    textarea:focus,
    select:focus {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent) !important;
    }
</style>
{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">{% trans 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' %}</a>
</h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block usertools %}
{% if has_permission %}
<div id="user-tools">


    <div class="admin-icons">
        <!-- ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <button class="admin-icon-btn" onclick="showNotifications()" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
            ğŸ””
            <span class="notification-badge" id="adminNotificationBadge">{{ unread_count }}</span>
        </button>

        <!-- âœ‰ï¸ Ù…Ø±Ø§Ø³Ù„Ø© ÙØ±Ø¯ÙŠØ© -->
        <button class="admin-icon-btn" onclick="openIndividualMessaging()" title="Ù…Ø±Ø§Ø³Ù„Ø© ÙØ±Ø¯ÙŠØ©">
            âœ‰ï¸
        </button>

        {% block userlinks %}

        <form id="logout-form" method="post" action="{% url 'admin:logout' %}">
            {% csrf_token %}
            <button type="submit">{% translate 'â‹' %}</button>
        </form>

        {% endblock %}
    </div>

</div>
{% endif %}
{% endblock %}

{% block extrahead %}
<script>
    // ===== Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Dark Mode Ù…Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù† =====
    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark-mode');
        const themeToggle = document.querySelector('.theme-toggle-btn');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
        if (themeToggle) {
            themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„ ÙÙŠ localStorage
        localStorage.setItem('darkMode', isDark);

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø³Ù„Ø³
        html.style.transition = 'all 0.3s ease';

        // ØªØ­Ø¯ÙŠØ« meta theme-color Ù„Ù„Ø¬ÙˆØ§Ù„
        updateThemeColor(isDark);
    }

    // ===== ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø«ÙŠÙ… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ø¬ÙˆØ§Ù„ =====
    function updateThemeColor(isDark) {
        const themeColor = document.querySelector('meta[name="theme-color"]');
        if (themeColor) {
            themeColor.setAttribute('content', isDark ? '#1e2a3a' : '#2c3e50');
        }
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =====
    document.addEventListener('DOMContentLoaded', function () {
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Dark Mode
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        const html = document.documentElement;
        const themeToggle = document.querySelector('.theme-toggle-btn');

        if (savedDarkMode) {
            html.classList.add('dark-mode');
            if (themeToggle) {
                themeToggle.textContent = 'â˜€ï¸';
            }
        } else if (themeToggle) {
            themeToggle.textContent = 'ğŸŒ™';
        }

        updateThemeColor(savedDarkMode);

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        setTimeout(() => {
            html.style.transition = '';
        }, 300);

        // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        loadAdminUnreadCount();

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Dark Mode ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        ensureDarkModeButton();
    });

    // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø± Dark Mode ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ =====
    function ensureDarkModeButton() {
        if (!document.querySelector('.theme-toggle-btn')) {
            const userTools = document.querySelector('#user-tools');
            if (userTools) {
                const themeButton = document.createElement('button');
                themeButton.className = 'theme-toggle-btn';
                themeButton.innerHTML = document.documentElement.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
                themeButton.title = 'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
                themeButton.onclick = toggleDarkMode;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                const adminIcons = document.querySelector('.admin-icons');
                if (adminIcons) {
                    adminIcons.insertBefore(themeButton, adminIcons.firstChild);
                } else {
                    userTools.insertBefore(themeButton, userTools.firstChild);
                }
            }
        }
    }

    // ===== Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ =====
    function loadAdminUnreadCount() {
        fetch('/messaging/unread/admin/1/')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('adminNotificationBadge');
                if (badge && data.unread_count > 0) {
                    badge.textContent = data.unread_count;
                    badge.style.display = 'flex';
                } else if (badge) {
                    badge.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading admin notifications:', error);
            });
    }

    function createModalOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.onclick = closeAllModals;
        document.body.appendChild(overlay);
        return overlay;
    }

    function closeAllModals() {
        document.querySelectorAll('.messaging-modal, .modal-overlay').forEach(el => {
            el.remove();
        });
    }

    function showNotifications() {
        closeAllModals();
        const overlay = createModalOverlay();

        const notificationsHTML = `
            <div class="messaging-modal">
                <div class="modal-header">
                    <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <button class="close-btn" onclick="closeAllModals()">âœ•</button>
                </div>
                <div class="modal-content">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTab('notifications')">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
                        <button class="tab-btn" onclick="switchTab('messages')">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
                    </div>
                    <div id="notifications-tab" class="tab-content active">
                        <div class="notifications-list" id="notificationsList">
                            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</div>
                        </div>
                    </div>
                    <div id="messages-tab" class="tab-content">
                        <div class="messages-list" id="messagesList">
                            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', notificationsHTML);
        loadNotifications();
    }

    function openBroadcastMessaging() {
        closeAllModals();
        const overlay = createModalOverlay();

        const messagingHTML = `
            <div class="messaging-modal">
                <div class="modal-header">
                    <h3>Ù…Ø±Ø§Ø³Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                    <button class="close-btn" onclick="closeAllModals()">âœ•</button>
                </div>
                <div class="modal-content">
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©:</label>
                        <select id="message-type" class="form-select" onchange="toggleMessageType()">
                            <option value="bulk">Ù…Ø±Ø§Ø³Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</option>
                            <option value="individual">Ù…Ø±Ø§Ø³Ù„Ø© ÙØ±Ø¯ÙŠØ©</option>
                        </select>
                    </div>
                    <div id="bulk-message" class="message-type-content">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†:</label>
                            <select id="bulk-recipient-type" class="form-select" onchange="toggleBulkOptions()">
                                <option value="all_students">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
                                <option value="course_students">Ø·Ù„Ø§Ø¨ ÙƒÙˆØ±Ø³ Ù…Ø­Ø¯Ø¯</option>
                            </select>
                        </div>
                        <div id="course-selector" class="form-group hidden">
                            <label>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³:</label>
                            <select id="course-id" class="form-select">
                                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</option>
                            </select>
                        </div>
                    </div>
                    <div id="individual-message" class="message-type-content hidden">
                        <div class="form-group">
                            <label>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                            <select id="student-id" class="form-select">
                                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                        <input type="text" id="message-title" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©" required>
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                        <textarea id="message-content" class="form-textarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..." rows="5" required></textarea>
                    </div>
                    <button class="send-btn" onclick="sendAdminMessage()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', messagingHTML);
        loadFormData();
    }

    function openIndividualMessaging() {
        openBroadcastMessaging();
        document.getElementById('message-type').value = 'individual';
        toggleMessageType();
    }

    function loadFormData() {
        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
        fetch('/admins/courses-list/')
            .then(response => response.json())
            .then(data => {
                const courseSelect = document.getElementById('course-id');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>';
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        courseSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                const courseSelect = document.getElementById('course-id');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</option>';
                }
            });

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
        fetch('/admins/students-list/')
            .then(response => response.json())
            .then(data => {
                const studentSelect = document.getElementById('student-id');
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>';
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} - ${student.phone_number}`;
                        studentSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading students:', error);
                const studentSelect = document.getElementById('student-id');
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</option>';
                }
            });
    }

    function toggleMessageType() {
        const type = document.getElementById('message-type').value;
        const bulkMessage = document.getElementById('bulk-message');
        const individualMessage = document.getElementById('individual-message');

        if (bulkMessage && individualMessage) {
            bulkMessage.classList.toggle('hidden', type !== 'bulk');
            individualMessage.classList.toggle('hidden', type !== 'individual');
        }
    }

    function toggleBulkOptions() {
        const type = document.getElementById('bulk-recipient-type').value;
        const courseSelector = document.getElementById('course-selector');
        if (courseSelector) {
            courseSelector.classList.toggle('hidden', type !== 'course_students');
        }
    }

    function sendAdminMessage() {
        const messageType = document.getElementById('message-type').value;
        const title = document.getElementById('message-title').value;
        const content = document.getElementById('message-content').value;

        if (!title || !content) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            return;
        }

        const messageData = {
            title: title,
            content: content,
            sender_type: 'admin',
            sender_id: 1
        };

        if (messageType === 'bulk') {
            messageData.receiver_type = document.getElementById('bulk-recipient-type').value;
            if (messageData.receiver_type === 'course_students') {
                const courseId = document.getElementById('course-id').value;
                if (!courseId) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙˆØ±Ø³');
                    return;
                }
                messageData.course_id = courseId;
            }
        } else {
            const studentId = document.getElementById('student-id').value;
            if (!studentId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨');
                return;
            }
            messageData.receiver_type = 'student';
            messageData.receiver_id = studentId;
        }

        fetch('/messaging/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    closeAllModals();
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            });
    }

    function switchTab(tabName) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }

        if (event && event.target) {
            event.target.classList.add('active');
        }

        if (tabName === 'notifications') {
            loadNotifications();
        } else {
            loadMessages();
        }
    }

    function loadNotifications() {
        const notificationsList = document.getElementById('notificationsList');
        if (!notificationsList) return;

        notificationsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</div>';

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        setTimeout(() => {
            notificationsList.innerHTML = `
                <div class="notification-item unread">
                    <div class="notification-icon">ğŸ“¢</div>
                    <div class="notification-content">
                        <div class="notification-title">Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
                        <div class="notification-preview">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                        <div class="notification-time">Ù…Ù†Ø° Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚</div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-icon">ğŸ’°</div>
                    <div class="notification-content">
                        <div class="notification-title">Ø´Ø­Ù† Ø±ØµÙŠØ¯</div>
                        <div class="notification-preview">Ù‚Ø§Ù… Ø·Ø§Ù„Ø¨ Ø¨Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø¨Ù…Ø¨Ù„Øº 100 Ø¬Ù†ÙŠÙ‡</div>
                        <div class="notification-time">Ù…Ù†Ø° Ø³Ø§Ø¹Ø©</div>
                    </div>
                </div>
                <div class="empty-state">
                    <div class="icon">ğŸ””</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                </div>
            `;
        }, 1000);
    }

    function loadMessages() {
        const messagesList = document.getElementById('messagesList');
        if (!messagesList) return;

        messagesList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        setTimeout(() => {
            messagesList.innerHTML = `
                <div class="message-item unread">
                    <div class="message-icon">ğŸ‘¤</div>
                    <div class="message-content">
                        <div class="message-title">Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ø­Ù…Ø¯</div>
                        <div class="message-preview">Ø£ÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...</div>
                        <div class="message-time">Ù…Ù†Ø° Ù£Ù  Ø¯Ù‚ÙŠÙ‚Ø©</div>
                    </div>
                </div>
                <div class="message-item">
                    <div class="message-icon">ğŸ‘¤</div>
                    <div class="message-content">
                        <div class="message-title">Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ù…Ø¯</div>
                        <div class="message-preview">Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡ÙˆØ¯ Ø§Ù„Ù…Ø¨Ø°ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©...</div>
                        <div class="message-time">Ù…Ù†Ø° Ø³Ø§Ø¹ØªÙŠÙ†</div>
                    </div>
                </div>
                <div class="empty-state">
                    <div class="icon">âœ‰ï¸</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                </div>
            `;
        }, 1000);
    }

    // ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ù…Ø§Ù† =====
    // Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let isDataLoading = false;

    // ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    function handleApiError(error, context) {
        console.error(`Error in ${context}:`, error);
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§
    }

    // ØªØ­Ø³ÙŠÙ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    window.addEventListener('beforeunload', function () {
        closeAllModals();
    });
</script>
{% endblock %}